<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jotter~O - Emotion and Chat</title>
    <link rel="stylesheet" href="../static/css/main.css">
    <style>
        /* Ensure button placement and styling */
        .input-container {
            display: flex;
            flex-direction: column; /* Stack input and buttons */
            gap: 10px; /* Add spacing between input and button group */
        }

        .button-container {
            display: flex;
            gap: 10px; /* Add spacing between buttons */
        }

        .button-container button {
            padding: 10px 20px;
            background-color: #36131d;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }

        .button-container button:hover {
            background-color: #5a1e2c;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar__container">
            <a href="index.html" class="navbar__logo">
                <img src="{{ url_for('static', filename='img/Jotter~O Logo.png') }}" alt="Jotter~O Logo" class="navbar__logo-img">
            </a>
            <ul class="navbar__menu">
                <li><a href="{{ url_for('home') }}#get-started" class="navbar__link">GET STARTED</a></li>
                <li><a href="https://forms.office.com/r/na6ggnwraG" class="navbar__link">EVALUATION</a></li>
                <li><a href="{{ url_for('data_privacy') }}" class="navbar__link">DATA PRIVACY</a></li>
                <li><a href="{{ url_for('contact') }}" class="navbar__link">CONTACT US</a></li>
            </ul>
        </div>
    </nav>

    <div class="background" style="background-image: url('../static/img/main\ bg.png'); height: 100vh; background-size: cover; background-position: center;">
    </div>

    <!-- Live Emotion Detection -->
    <div class="video_feed">
        <h1>Real-Time Emotion Detection</h1>
        <img src="/video_feed" alt="Video Feed">
        <p>Press <b>Q</b> on the webcam window to stop the application.</p>
    </div>

    <!-- Chatbot -->
    <div class="chat-container">
        <h1>Chat with Jotter~O</h1>
        <div id="response" class="chat-box"></div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Type your message here...">
            <div class="button-container">
                <button onclick="sendMessage()">Send</button>
                <button id="record-btn" onclick="toggleRecording()">ðŸŽ¤</button>
            </div>
        </div>
    </div>

<script>
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    async function toggleRecording() {
        const recordButton = document.getElementById("record-btn");

        if (!isRecording) {
            // Start recording
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);

            // Send chunks to the server for transcription in real-time
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append('audio', audioBlob, "recorded_audio.webm");

                const response = await fetch('/whisper', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                // Update the input field with the live transcription
                document.getElementById("user-input").value = data.transcription;
            };

            mediaRecorder.start();
            recordButton.textContent = "ðŸ›‘ Stop";
            isRecording = true;
        } else {
            // Stop recording
            mediaRecorder.stop();
            recordButton.textContent = "ðŸŽ¤";
            isRecording = false;
        }
    }

    async function sendMessage() {
        const userMessage = document.getElementById("user-input").value;
        const responseElement = document.getElementById("response");

        // Append user's message
        responseElement.innerHTML += `<p class="user-message">You: ${userMessage}</p>`;

        // Fetch bot response
        const response = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMessage })
        });
        const data = await response.json();

        // Append bot's response
        responseElement.innerHTML += `<p class="bot-response">Jotter~O: ${data.response}</p>`;
        responseElement.scrollTop = responseElement.scrollHeight;

        // Clear the input field
        document.getElementById("user-input").value = "";
    }

</script>
</body>
</html>
